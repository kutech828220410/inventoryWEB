<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>驗收入庫</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="inspection.css">
  <script src="ApiURL.js"></script>
  <script src="WebApiFunc.js"></script>
  <script src="/dist/JsBarcode.all.js"></script>
  <!-- <script src="frontpage.js"></script> -->
  <script src="inspection.js"></script>

  
</head>
<body>
  
  <div class="h1top">
    <h1 class="h1_inspection">驗收入庫</h1>
    <div class="pagination">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleCK" checked>
        <label class="form-check-label" for="toggleLB">Scanner</label>
      </div>
      <button id="submitFormbtn" onclick="submitForm()">送出</button>
    </div>
  </div>
  <div class="serch_div">
    <input type="text" class="drugNameText" placeholder="藥名搜尋" onkeydown="search_By_name_Event(event)">
    <b style="font-size: 12px; height: 30px ;margin-left: 10px;padding-right:5px; padding-left:5px; border-style:dashed;">${_index + 1}</b>
  </div>

  <div class="table-container">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th style="font-weight: bolder;font-size: 18px;">藥品資訊</th>
                <th style="font-weight: bolder;font-size: 18px;">數量</th>
            </tr>
        </thead>
<script>
  
function validateInput(myModal1) {

  if (!myModal1) return;
  
  var lotInputs = myModal1.querySelectorAll(".lot");
  var dateInputs = myModal1.querySelectorAll(".date");
  var qtyInputs = myModal1.querySelectorAll(".qty");
  
  var allInputsValid = true;
  // loop through each input and validate
  for (let i = 0; i < lotInputs.length; i++) {
    const lot = lotInputs[i].value;
    const date = dateInputs[i].value;
    const qty = qtyInputs[i].value;
  

    if (!lot.trim() && !date.trim() && !qty.trim() ) {
      // 如果全部輸入欄位都是空白的，關閉彈跳視窗
      myModal1.style.display='none';
    } else if (!lot.trim() || !date.trim() || !qty.trim() ) {
      // 如果有任何一格未填，跳出警示提醒
      alert("請填寫完整驗收資訊！");
      allInputsValid = false;
      break;
    }
  }
  
  if (allInputsValid) {
    // 如果全部都填寫了，關閉彈跳視窗
    myModal1.style.display='none';
  }
}

//新增批效
let rowNum = 1;            
function addNewRow(myModal1) {
  if (!myModal1) return;
  const lotInputs = myModal1.querySelectorAll(".lot");
  const dateInputs = myModal1.querySelectorAll(".date");
  const qtyInputs = myModal1.querySelectorAll(".qty");

  let alertMsg = myModal1.querySelector("#alertMsg"); // 建立一個新的 HTML 元素

// loop through each input and validate
  for (let i = 0; i < lotInputs.length; i++) 
  {
      const lot = lotInputs[i].value;
      const date = dateInputs[i].value;
      const qty = qtyInputs[i].value;

      if (!lot.trim() || !date.trim() || !qty.trim() )
      {
        if (alertMsg) {
          alertMsg.remove(); // 如果已經有警示訊息存在，先移除它
        }
        alertMsg = document.createElement("div"); // 建立一個新的 HTML 元素
        alertMsg.id = "alertMsg";
        alertMsg.style.color = "red"; // 設定警示訊息的文字顏色
        alertMsg.style.fontWeight = "bold"; // 設定警示訊息的文字粗體
        alertMsg.style.textAlign = "center"; // 設定警示訊息的文字水平置中
        alertMsg.innerText = "請填寫完整驗收資訊再新增驗收藥品！"; // 設定警示訊息的文字內容
        const addRowBtn = myModal1.querySelector(".addRowBtn"); // 取得新增按鈕元素
        addRowBtn.insertAdjacentElement("afterend", alertMsg); // 將警示訊息插入到按鈕下方
        return;
      }
  }
  if (alertMsg)
  {
    alertMsg.remove(); // 如果已經有警示訊息存在，移除它
  }

  const rows = myModal1.querySelector(`.Modalrows`);
  console.log(rows);
  // create divs
  const div1 = document.createElement("div");
  const div2 = document.createElement("div");
  const div3 = document.createElement("div");
  
  // create inputs
  const lotInput = document.createElement("input");
  const expInput = document.createElement("input");
  const qtyInput = document.createElement("input");
  const delBtn = document.createElement("button")
  
  // set input attributes
  div1.style.display = "flex";
  div1.style.flexDirection = "row";
  div1.style.justifyContent = "space-between";
  div1.style.alignItems = "center";
  lotInput.id = "lot1"
  lotInput.type = "text";
  lotInput.className = "lot";
  lotInput.placeholder = "請輸入批號";
  expInput.id = "date1"
  expInput.type = "date";
  expInput.className = "date";
  expInput.placeholder = "請選擇效期";
  qtyInput.id = "qty1"
  qtyInput.type = "number";
  qtyInput.className = "qty";
  qtyInput.placeholder = "請輸入數量";
  qtyInput.min = "0";
  qtyInput.max = "9999";
  qtyInput.inputmode = "numeric";
  delBtn.innerHTML = "<i class='bi bi-x'></i>";
  delBtn.style.border = "2px solid #ff0000";
  delBtn.style.backgroundColor = "#ff0000";
  delBtn.style.color = "#fff";
  delBtn.style.cursor = "pointer";


  delBtn.addEventListener("click", function () {
      const divs = myModal1.querySelectorAll("#rows1 > div");
      const div1 = divs[divs.length - 3];
      const div2 = divs[divs.length - 2];
      const div3 = divs[divs.length - 1];
      div1.remove();
      div2.remove();
      div3.remove();
      rowNum--;
      updateRowNum();
  });

  // create text nodes
  const orderText = document.createTextNode("<div style=  flex-direction: row;'> <b>驗收單號:20230514-1 <n> (新增批效: " + rowNum + ")</b> </div> ");
  const lotText = document.createTextNode("<b>批號</b>:");
  const expText = document.createTextNode("<b>效期</b>:");
  const qtyText = document.createTextNode("<b>數量</b>:");
  // append text to divs
  div1.innerHTML = orderText.textContent;  
  div1.appendChild(delBtn);
  div2.innerHTML = lotText.textContent;
  div2.appendChild(lotInput);
  div2.appendChild(document.createTextNode(" "));
  div2.innerHTML += expText.textContent;
  div2.appendChild(expInput);
  div3.innerHTML = qtyText.textContent;
  div3.appendChild(qtyInput);
  // append divs to rows
  rows.appendChild(div1);
  rows.appendChild(div2);
  rows.appendChild(div3);
  
  // increment row number
  rowNum++;
  
  // add color style
  if (rowNum % 2 === 1) {
    div1.style.backgroundColor = "#ffffff";
    div2.style.backgroundColor = "#ffffff";
    div3.style.backgroundColor = "#ffffff";
  } else {
    div1.style.backgroundColor = "#c1dcffe3";
    div2.style.backgroundColor = "#c1dcffe3";
    div3.style.backgroundColor = "#c1dcffe3";
  }
}
</script>
          
          
          
      
      </div>
    </div>
      </td>

  </tr>


</tbody>
<!-- end -->

    </table>
  </div>


  <div class="under-line">
    <B> Copyright ©2023 鴻森整合機電有限公司 </B>
  </div>
  
  
  <script>

    var barcode_value = '';
    // 監聽頁面的keydown事件
     window.addEventListener('keydown', function(event) {
        // 判斷按下的按鍵是否是Tab鍵或Enter鍵
        if (event.key === 'Tab' || event.key === 'Enter') {
        // 防止頁面重新載入
            event.preventDefault();
            const parsedCode = parseBarcode(barcode_value);
            
            // 取得輸入框的值
            barcode_value = '';
            // 解析藍牙掃描器返回的數據
            if(parsedCode != '' && document.getElementById("toggleCK").checked)
            {
                console.log(parsedCode);
                searchItem(data.Data, parsedCode).then((result) => {
                  const dataLength = result.length;
                  if(dataLength == 0) return;
                  if(dataLength == 1)
                  {
                    const qty = prompt(`藥名:${result[0].NAME}\n 請輸入數量：`);
                    if(qty)
                    {
                      set_END_QTY(result[0].GUID,qty);
                      updateQtyByGuid(result[0].GUID,qty);
                    }
                  }
                  else
                  {
                    search_By_name(result[0].NAME);
                  }
                  
                
                }).catch((error) => {
                  console.error(error);
                });
            }         
        }
        else
        {
            const isValid = /^[a-zA-Z0-9]+$/.test(event.key);
            const isControlKey = event.keyCode < 48 || event.keyCode > 90;
            if (isValid && !isControlKey) {
                // 將解析後的條碼值設定為輸入框的值
                barcode_value += event.key;
            } 
        }
    });

    // 解析帶有分隔符的字符串
    function parseBarcode(scannedCode) {
    const delimiter = /[\n\r]/g;
    const matches = scannedCode.split(delimiter);
    return matches[0];
    }
    
  </script>
  
  </body>
</html>
